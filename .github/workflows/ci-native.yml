name: native build & test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    # Run daily at 00:00 (https://crontab.guru/#0_0_*_*_*).
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      BAZEL: bazelisk-linux-amd64
      XDG_CACHE_HOME: ~/.cache/bazel-repo
    steps:
    - uses: actions/checkout@v4

    - name: Install p4c system dependencies (Flex, Bison, GMP)
      run: sudo apt-get update && sudo apt-get install bison flex libfl-dev libgmp-dev

    - name: Mount bazel caches
      uses: actions/cache/restore@v3
      id: restore-cache
      with:
        key: bazel
        path: |
          "~/.cache/bazel"
          "~/.cache/bazel-repo"

    - name: Install bazelisk
      run: |
        curl -LO "https://github.com/bazelbuild/bazelisk/releases/download/v1.7.4/$BAZEL"
        chmod +x $BAZEL

    - name: bazel build //...
      run: |
        ./$BAZEL \
          --bazelrc=$GITHUB_WORKSPACE/.github/workflows/ci.bazelrc \
          build //...

    - name: bazel test //...
      run: |
        ./$BAZEL \
          --bazelrc=$GITHUB_WORKSPACE/.github/workflows/ci.bazelrc \
          test //...

    - name: Save cache
      uses: actions/cache/save@v3
      if: always()
      with:
        key: ${{ steps.restore-cache.outputs.cache-primary-key }}
        path: |
          "~/.cache/bazel"
          "~/.cache/bazel-repo"
